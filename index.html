import React, { useState, useEffect } from 'react';
import { Eye, EyeOff, Plus, Trash2, Copy, Lock, Unlock, Search } from 'lucide-react';

const PasswordManager = () => {
  const [isLocked, setIsLocked] = useState(true);
  const [masterPassword, setMasterPassword] = useState('');
  const [storedMasterHash, setStoredMasterHash] = useState('');
  const [passwords, setPasswords] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [showNewPassword, setShowNewPassword] = useState(false);
  const [newEntry, setNewEntry] = useState({
    site: '',
    username: '',
    password: '',
    notes: ''
  });
  const [visiblePasswords, setVisiblePasswords] = useState({});
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      const masterResult = await window.storage.get('master_hash');
      if (masterResult) {
        setStoredMasterHash(masterResult.value);
      }
      
      const passwordsResult = await window.storage.get('passwords_data');
      if (passwordsResult) {
        setPasswords(JSON.parse(passwordsResult.value));
      }
    } catch (err) {
      console.log('Primo accesso o dati non trovati');
    }
  };

  const hashPassword = async (password) => {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash))
      .map(b => b.toString(16).padStart(2, '0'))
      .join('');
  };

  const encrypt = (text, key) => {
    return btoa(text + '::' + key);
  };

  const decrypt = (encrypted, key) => {
    try {
      const decoded = atob(encrypted);
      const parts = decoded.split('::');
      if (parts[1] === key) {
        return parts[0];
      }
      return null;
    } catch {
      return null;
    }
  };

  const handleUnlock = async () => {
    if (!storedMasterHash) {
      const hash = await hashPassword(masterPassword);
      await window.storage.set('master_hash', hash);
      setStoredMasterHash(hash);
      setIsLocked(false);
      setError('');
      setSuccess('Password principale impostata!');
      setTimeout(() => setSuccess(''), 3000);
      return;
    }

    const hash = await hashPassword(masterPassword);
    if (hash === storedMasterHash) {
      setIsLocked(false);
      setError('');
      setSuccess('Accesso effettuato!');
      setTimeout(() => setSuccess(''), 2000);
    } else {
      setError('Password errata!');
      setTimeout(() => setError(''), 3000);
    }
  };

  const handleAddPassword = async () => {
    if (!newEntry.site || !newEntry.password) {
      setError('Compila almeno sito e password');
      setTimeout(() => setError(''), 3000);
      return;
    }

    const encryptedEntry = {
      id: Date.now(),
      site: newEntry.site,
      username: newEntry.username,
      password: encrypt(newEntry.password, masterPassword),
      notes: newEntry.notes,
      createdAt: new Date().toISOString()
    };

    const updatedPasswords = [...passwords, encryptedEntry];
    setPasswords(updatedPasswords);
    await window.storage.set('passwords_data', JSON.stringify(updatedPasswords));

    setNewEntry({ site: '', username: '', password: '', notes: '' });
    setShowNewPassword(false);
    setSuccess('Password salvata!');
    setTimeout(() => setSuccess(''), 2000);
  };

  const handleDeletePassword = async (id) => {
    const updatedPasswords = passwords.filter(p => p.id !== id);
    setPasswords(updatedPasswords);
    await window.storage.set('passwords_data', JSON.stringify(updatedPasswords));
    setSuccess('Password eliminata');
    setTimeout(() => setSuccess(''), 2000);
  };

  const copyToClipboard = (text) => {
    const decrypted = decrypt(text, masterPassword);
    if (decrypted) {
      navigator.clipboard.writeText(decrypted);
      setSuccess('Copiato!');
      setTimeout(() => setSuccess(''), 2000);
    }
  };

  const togglePasswordVisibility = (id) => {
    setVisiblePasswords(prev => ({
      ...prev,
      [id]: !prev[id]
    }));
  };

  const filteredPasswords = passwords.filter(p =>
    p.site.toLowerCase().includes(searchTerm.toLowerCase()) ||
    p.username.toLowerCase().includes(searchTerm.toLowerCase())
  );

  if (isLocked) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
          <div className="flex justify-center mb-6">
            <div className="bg-indigo-100 p-4 rounded-full">
              <Lock className="w-12 h-12 text-indigo-600" />
            </div>
          </div>
          
          <h1 className="text-3xl font-bold text-center mb-2 text-gray-800">
            Password Manager
          </h1>
          <p className="text-center text-gray-600 mb-8">
            {storedMasterHash ? 'Inserisci la password principale' : 'Imposta una password principale'}
          </p>

          {error && (
            <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
              {error}
            </div>
          )}

          {success && (
            <div className="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-4">
              {success}
            </div>
          )}

          <input
            type="password"
            value={masterPassword}
            onChange={(e) => setMasterPassword(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && handleUnlock()}
            placeholder="Password principale"
            className="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />

          <button
            onClick={handleUnlock}
            className="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors"
          >
            {storedMasterHash ? 'Sblocca' : 'Crea Password'}
          </button>

          <div className="mt-6 p-4 bg-blue-50 rounded-lg">
            <p className="text-sm text-gray-700">
              <strong>Nota:</strong> La password principale non può essere recuperata. Assicurati di ricordarla!
            </p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
      <div className="max-w-4xl mx-auto">
        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-3">
              <Unlock className="text-indigo-600" />
              Le Tue Password
            </h1>
            <button
              onClick={() => {
                setIsLocked(true);
                setMasterPassword('');
              }}
              className="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors"
            >
              Blocca
            </button>
          </div>

          {success && (
            <div className="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-4">
              {success}
            </div>
          )}

          {error && (
            <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
              {error}
            </div>
          )}

          <div className="flex gap-3 mb-6">
            <div className="flex-1 relative">
              <Search className="absolute left-3 top-3 text-gray-400 w-5 h-5" />
              <input
                type="text"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                placeholder="Cerca sito o username..."
                className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
              />
            </div>
            <button
              onClick={() => setShowNewPassword(!showNewPassword)}
              className="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2"
            >
              <Plus className="w-5 h-5" />
              Nuova
            </button>
          </div>

          {showNewPassword && (
            <div className="bg-indigo-50 p-6 rounded-lg mb-6">
              <h3 className="font-semibold text-lg mb-4 text-gray-800">Aggiungi Password</h3>
              <div className="space-y-3">
                <input
                  type="text"
                  value={newEntry.site}
                  onChange={(e) => setNewEntry({...newEntry, site: e.target.value})}
                  placeholder="Sito (es. facebook.com)"
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
                <input
                  type="text"
                  value={newEntry.username}
                  onChange={(e) => setNewEntry({...newEntry, username: e.target.value})}
                  placeholder="Username o Email"
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
                <input
                  type="password"
                  value={newEntry.password}
                  onChange={(e) => setNewEntry({...newEntry, password: e.target.value})}
                  placeholder="Password"
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
                <textarea
                  value={newEntry.notes}
                  onChange={(e) => setNewEntry({...newEntry, notes: e.target.value})}
                  placeholder="Note (opzionale)"
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  rows="2"
                />
                <div className="flex gap-3">
                  <button
                    onClick={handleAddPassword}
                    className="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition-colors"
                  >
                    Salva
                  </button>
                  <button
                    onClick={() => {
                      setShowNewPassword(false);
                      setNewEntry({ site: '', username: '', password: '', notes: '' });
                    }}
                    className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors"
                  >
                    Annulla
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>

        <div className="space-y-4">
          {filteredPasswords.length === 0 ? (
            <div className="bg-white rounded-xl p-8 text-center text-gray-500">
              {passwords.length === 0 ? 'Nessuna password salvata. Aggiungi la tua prima password!' : 'Nessun risultato trovato'}
            </div>
          ) : (
            filteredPasswords.map((entry) => {
              const decryptedPassword = decrypt(entry.password, masterPassword);
              return (
                <div key={entry.id} className="bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition-shadow">
                  <div className="flex justify-between items-start mb-3">
                    <div className="flex-1">
                      <h3 className="text-xl font-bold text-gray-800">{entry.site}</h3>
                      {entry.username && (
                        <p className="text-gray-600 mt-1">{entry.username}</p>
                      )}
                    </div>
                    <button
                      onClick={() => handleDeletePassword(entry.id)}
                      className="text-red-500 hover:text-red-700 p-2"
                    >
                      <Trash2 className="w-5 h-5" />
                    </button>
                  </div>

                  <div className="flex items-center gap-3 mb-3">
                    <div className="flex-1 bg-gray-100 px-4 py-2 rounded-lg font-mono text-sm">
                      {visiblePasswords[entry.id] ? decryptedPassword : '••••••••••••'}
                    </div>
                    <button
                      onClick={() => togglePasswordVisibility(entry.id)}
                      className="p-2 hover:bg-gray-100 rounded-lg"
                    >
                      {visiblePasswords[entry.id] ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
                    </button>
                    <button
                      onClick={() => copyToClipboard(entry.password)}
                      className="p-2 hover:bg-gray-100 rounded-lg"
                    >
                      <Copy className="w-5 h-5" />
                    </button>
                  </div>

                  {entry.notes && (
                    <p className="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">{entry.notes}</p>
                  )}
                </div>
              );
            })
          )}
        </div>
      </div>
    </div>
  );
};

export default PasswordManager;
